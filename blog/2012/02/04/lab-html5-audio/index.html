<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>HTML5 audio 實驗 | Zespia</title>
  <meta name="author" content="SkyArrow">
  
  <meta name="description" content="寒假即將結束，不巧膝蓋突然中了一箭，便決定實驗 HTML5 audio標籤的效果，雖然已有 jPlayer 這款輕便好用的播放器，但不折騰一下就沒辦法消磨時間了，所以本次的實驗品完全由我操刀。">
  
  
  <meta name="viewport" content="width=device-width; initial-scale=1; maximum-scale=1">

  <meta property="og:title" content="HTML5 audio 實驗"/>
  <meta property="og:site_name" content="Zespia"/>

  <link rel="alternate" href="http://feeds.feedburner.com/zespia" title="Zespia" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8/jquery.min.js"></script>
  
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-4910098-7']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>

</head>

<body>
  <header id="header" class="inner"><div class="alignleft">
  <h1><a href="/">Zespia</a></h1>
  <h2><a href="/"></a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/">Home</a></li>
    
      <li><a href="/archives">Archives</a></li>
    
      <li><a href="https://github.com/tommy351">GitHub</a></li>
    
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div></header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper">

<article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2012-02-04T05:29:00.000Z"><a href="/blog/2012/02/04/lab-html5-audio/">2012/2/4</a></time>
      
      
  
    <h1 class="title">HTML5 audio 實驗</h1>
  

    </header>
    <div class="entry">
      
        <p><img src="http://i.minus.com/inE9d4C1xPbYD.png" alt="">

</p>
<p>寒假即將結束，不巧膝蓋突然中了一箭，便決定實驗 HTML5 <code>audio</code>標籤的效果，雖然已有 <a href="http://jplayer.org/">jPlayer</a> 這款輕便好用的播放器，但不折騰一下就沒辦法消磨時間了，所以本次的實驗品完全由我操刀。

</p>
<span id="more"></span>

<h2>開始之前</h2>
<p>首先必須了解<code>audio</code>標籤的使用方式：

</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><code><div class="line-number">1</div><div class="line-number">2</div><div class="line-number">3</div><div class="line-number">4</div></code></pre></td><td class="code"><pre><code><div class="line">&lt;audio controls&gt;</div><div class="line">	&lt;source src="music.mp3"&gt;</div><div class="line">	&lt;source src="music.ogg"&gt;</div><div class="line">&lt;/audio&gt;</div></code></pre></td></tr></table></figure>

<p>輸入以上代碼後，便可在網頁中看到瀏覽器內建的播放器。每種瀏覽器支援的播放類型不一，最保險的方法是備妥<code>mp3</code>、<code>ogg</code>。

</p>
<p>為了浪費時間，當然不可能用瀏覽器的預設介面，所以刪除<code>controls</code>屬性，透過 JavaScript 操作：

</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><code><div class="line-number">1</div><div class="line-number">2</div><div class="line-number">3</div><div class="line-number">4</div><div class="line-number">5</div></code></pre></td><td class="code"><pre><code><div class="line"><span class="keyword">var</span> audio = document.getElementsByTagName(<span class="string">'audio'</span>)[<span class="number">0</span>];</div><div class="line"><span class="comment">// 播放</span></div><div class="line">audio.play();</div><div class="line"><span class="comment">// 暫停</span></div><div class="line">audio.pause();</div></code></pre></td></tr></table></figure>

<p>只需要懂這兩個函數，就可製作最基礎的播放器了，其他複雜的指令可參閱文末的參考出處。

</p>
<h2>介面</h2>
<p>寫網頁時，比起最重要的 JavaScript，我習慣先寫 CSS，最初的參考範本是 Mac 的 <a href="http://zh.wikipedia.org/wiki/Cover_Flow">CoverFlow</a>。

</p>
<p><img src="http://i.minus.com/ibtVhj6FYs9Hvw.png" alt="">

</p>
<p>經過一連串絞盡腦汁，寫了一堆亂七八糟的 CSS 之後，成品如下。

</p>
<p><img src="http://i.minus.com/iXoN5AU2JBOHU.png" alt="">

</p>
<p>無論是倒影、中間的圓圈進度表都與 <a href="http://zh.wikipedia.org/wiki/Cover_Flow">CoverFlow</a> 非常相像，但這種樣式實在 <del>太麻煩了</del> 不便使用者操作，所以從 <a href="http://www.premiumpixels.com/freebies/compact-music-player-psd/">Premium Pixels</a> 偷點子過來，稍微加油添醋一下，完成了播放器介面 Ver. 2。

</p>
<p><img src="http://i.minus.com/imrTH5W7km1vj.png" alt="Ver.2 與 Ver.1 完全不像？這種事情不重要啦！">

</p>
<h2>核心</h2>
<p>介面完成自爽一下之後，就得面對麻煩的 JavaScript 了，播放、暫停非常簡單，按鈕按下去執行鄉對應的動作即可，然而音量調整與進度條該如何處理呢？

</p>
<p>雖然本次的重點是<strong>消磨時間</strong>，但再去造一個輪子實在他媽的太累了，於是 <del>聰明如我</del> 請到了 <a href="http://jqueryui.com/">jQuery UI</a>，Slider 功能壓縮後需要約 20KB 的空間，有點龐大不過方便就好。

</p>
<p>時間的控制方式如下，單位為秒數，例如跳至第 100 秒的位置：

</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><code><div class="line-number">1</div></code></pre></td><td class="code"><pre><code><div class="line">audio.currentTime = <span class="number">100</span>;</div></code></pre></td></tr></table></figure>

<p>音量的控制方式如下，範圍為 0~1，例如將音量調整至一半大小：

</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><code><div class="line-number">1</div></code></pre></td><td class="code"><pre><code><div class="line">audio.volume = <span class="number">0.5</span>;</div></code></pre></td></tr></table></figure>

<p><code>audio</code>可綁定<code>play</code>, <code>pause</code>, <code>ended</code>, <code>progress</code>, <code>canplay</code>, <code>timeupdate</code>等事件。<code>play</code>與<code>pause</code>如字面上意思，分別為播放、暫停後生效。

</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><code><div class="line-number">1</div><div class="line-number">2</div><div class="line-number">3</div><div class="line-number">4</div><div class="line-number">5</div><div class="line-number">6</div><div class="line-number">7</div></code></pre></td><td class="code"><pre><code><div class="line">audio.addEventListener(<span class="string">'play'</span>, <span class="keyword">function</span>(){</div><div class="line">	play.title = <span class="string">'pause'</span>;</div><div class="line">}, <span class="literal">false</span>);</div><br><div class="line">audio.addEventListener(<span class="string">'pause'</span>, <span class="keyword">function</span>(){</div><div class="line">	play.title = <span class="string">'play'</span>;</div><div class="line">}, <span class="literal">false</span>);</div></code></pre></td></tr></table></figure>

<p><code>ended</code>為結束後生效，當音樂結束後，可透過此事件讓時間歸零。

</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><code><div class="line-number">1</div><div class="line-number">2</div><div class="line-number">3</div></code></pre></td><td class="code"><pre><code><div class="line">audio.addEventListener(<span class="string">'ended'</span>, <span class="keyword">function</span>(){</div><div class="line">	<span class="keyword">this</span>.currentTime = <span class="number">0</span>;</div><div class="line">}, <span class="literal">false</span>);</div></code></pre></td></tr></table></figure>

<p>當音樂檔案開始載入後，便會啟動<code>progress</code>事件，可透過此事件監測下載進度。Firefox 可能會發生問題，建議搭配<code>durationchange</code>事件使用。

</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><code><div class="line-number">1</div><div class="line-number">2</div><div class="line-number">3</div><div class="line-number">4</div></code></pre></td><td class="code"><pre><code><div class="line">audio.addEventListener(<span class="string">'progress'</span>, <span class="keyword">function</span>(){</div><div class="line">	<span class="keyword">var</span> endVal = <span class="keyword">this</span>.seekable && <span class="keyword">this</span>.seekable.length ? <span class="keyword">this</span>.seekable.end(<span class="number">0</span>) : <span class="number">0</span>;</div><div class="line">	buffer.style.width = (<span class="number">100</span> / (<span class="keyword">this</span>.duration || <span class="number">1</span>) * endVal) + <span class="string">'%'</span>;</div><div class="line">}, <span class="literal">false</span>);</div></code></pre></td></tr></table></figure>

<p>當音樂下載到一定程度後，<code>canplay</code>事件便會生效，一般會透過此事件初始化播放器。相同類型的事件還有很多，依照啟動順序分別為：<code>loadstart</code>, <code>durationchange</code>, <code>loadeddata</code>, <code>progress</code>, <code>canplay</code>, <code>canplaythrough</code>。

</p>
<p><code>timeupdate</code>會在音樂播放時不斷生效，可透過此事件更新時間。

</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><code><div class="line-number">1</div><div class="line-number">2</div><div class="line-number">3</div></code></pre></td><td class="code"><pre><code><div class="line">audio.addEventListener(<span class="string">'timeupdate'</span>, <span class="keyword">function</span>(){</div><div class="line">	progress.style.width = (<span class="keyword">this</span>.currentTime / <span class="keyword">this</span>.duration) * <span class="number">100</span> + <span class="string">'%'</span>;</div><div class="line">}, <span class="literal">false</span>);</div></code></pre></td></tr></table></figure>

<h2>播放列表</h2>
<p>一個播放器的基礎功能就此完成，能夠播放、暫停、調整音量、調整時間。但這顯然還不夠，播放列表對於播放器而言相當重要。<em>（大概啦）</em>

</p>
<p><img src="http://i.minus.com/inE9d4C1xPbYD.png" alt="不要吐槽為啥播放列表裡全是動漫歌，林北就是宅啦...">

</p>
<p>與自己的邏輯奮戰大約一晚後，有播放列表、隨機播放、重複播放（單首、全部）功能的播放器於焉完成。只需要 214 行、約 6KB 的代碼<em>（未壓縮）</em>即可完成，應該能算是輕便簡易了。

</p>
<h2>後記</h2>
<p>播放列表的製作過程有點髒，中途還重構了幾次，所以直接看範例應該會比較快，若對於範例內的程式碼感到疑惑，可在下方留言。

</p>
<p>範例內已設定了一些參數，可在<code>js/script.js</code>內更改。第 5 行的<code>continous</code>參數為連續播放，第 6 行的<code>autoplay</code>參數為自動播放，第 7 行的<code>playlist</code>陣列請自行設定，壓縮檔內<strong>不會</strong>附帶範例內的音樂檔案。<code>playlist</code>陣列的格式如下：

</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><code><div class="line-number">1</div><div class="line-number">2</div><div class="line-number">3</div><div class="line-number">4</div><div class="line-number">5</div><div class="line-number">6</div><div class="line-number">7</div><div class="line-number">8</div><div class="line-number">9</div><div class="line-number">10</div></code></pre></td><td class="code"><pre><code><div class="line"><span class="keyword">var</span> playlist = [</div><div class="line">	{</div><div class="line">		title: <span class="string">'Tell Your World'</span>,</div><div class="line">		artist: <span class="string">'livetune feat. 初音ミク'</span>,</div><div class="line">		album: <span class="string">'Tell Your World'</span>,</div><div class="line">		cover: <span class="string">'cover/tell_your_world.jpg'</span>,</div><div class="line">		mp3: <span class="string">'music/tell_your_world.mp3'</span>,</div><div class="line">		ogg: <span class="string">'music/tell_your_world.ogg'</span></div><div class="line">	}</div><div class="line">];</div></code></pre></td></tr></table></figure>

<p><code>title</code>為標題，<code>artist</code>為演出者，<code>album</code>為專輯名稱，<code>cover</code>為專輯封面的路徑，<code>mp3</code>、<code>ogg</code>分別為音樂檔案的路徑，建議備妥兩種格式的檔案，<del>要不然 Firefox 和 Opera 不就只能去死了嗎？</del>

</p>
<p>因為做到最後頭腦快爆炸了，懶得做 Flash fallback，<del>IE 請去死一死吧。</del>

</p>
<p><a href="http://zespia.tw/lab/coverart">範例</a>｜<a href="http://zespia.tw/lab/coverart/example.zip">下載</a>

</p>
<h2>參考出處</h2>
<ul>
<li><a href="http://jplayer.org/">jPlayer</a></li>
<li><a href="http://blog.darkthread.net/post-2011-05-15-html5-audio.aspx">小試 HTML 5 audio - 黑暗執行緒</a></li>
<li><a href="https://developer.mozilla.org/en/Using_HTML5_audio_and_video">Using HTML5 audio and video - MDN</a></li>
<li><a href="http://net.tutsplus.com/tutorials/html-css-techniques/html5-audio-and-video-what-you-must-know/">HTML5 Audio and Video: What you Must Know | Nettuts+</a></li>
<li><a href="http://www.premiumpixels.com/freebies/compact-music-player-psd/">Free PSD: Compact Music Player | Premium Pixels</a></li>
</ul>

      
    </div>
    <footer>
      
        
        
  
  <div class="tags">
    <a href="/tags/JavaScript/">JavaScript</a>, <a href="/tags/HTML5/">HTML5</a>
  </div>

        
  <div class="addthis addthis_toolbox addthis_default_style">
    
      <a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
    
    
      <a class="addthis_button_tweet"></a>
    
    
      <a class="addthis_button_google_plusone" g:plusone:size="medium"></a>
    
    
      <a class="addthis_button_pinterest_pinit" pi:pinit:layout="horizontal"></a>
    
    <a class="addthis_counter addthis_pill_style"></a>
  </div>
  <script type="text/javascript" src="http://s7.addthis.com/js/300/addthis_widget.js#pubid=ra-4daee9911f9dfcb4"></script>

      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>


<section id="comment">
  <h1 class="title">Comments</h1>
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>
</div></div>
    <aside id="sidebar" class="alignright">
<div class="search">
  <form action="http://google.com/search" method="get" accept-charset="utf-8">
    <input type="text" name="q" results="0" placeholder="Search">
    <input type="hidden" name="q" value="site:zespia.tw">
  </form>
</div>


<div class="widget tag">
  <h3 class="title">Tags</h3>
  <ul class="entry">
  
    <li><a href="/tags/Android/">Android</a><small>1</small></li>
  
    <li><a href="/tags/CSS/">CSS</a><small>1</small></li>
  
    <li><a href="/tags/HTML5/">HTML5</a><small>2</small></li>
  
    <li><a href="/tags/Hexo/">Hexo</a><small>3</small></li>
  
    <li><a href="/tags/JavaScript/">JavaScript</a><small>8</small></li>
  
    <li><a href="/tags/Node.js/">Node.js</a><small>5</small></li>
  
    <li><a href="/tags/Octopress/">Octopress</a><small>4</small></li>
  
    <li><a href="/tags/PS3/">PS3</a><small>6</small></li>
  
    <li><a href="/tags/PSP/">PSP</a><small>2</small></li>
  
    <li><a href="/tags/Ruby/">Ruby</a><small>1</small></li>
  
    <li><a href="/tags/Windows/">Windows</a><small>1</small></li>
  
    <li><a href="/tags/WordPress/">WordPress</a><small>5</small></li>
  
    <li><a href="/tags/主題/">主題</a><small>6</small></li>
  
    <li><a href="/tags/同人誌/">同人誌</a><small>2</small></li>
  
    <li><a href="/tags/活動/">活動</a><small>2</small></li>
  
    <li><a href="/tags/漫畫/">漫畫</a><small>6</small></li>
  
    <li><a href="/tags/輕小說/">輕小說</a><small>8</small></li>
  
    <li><a href="/tags/遊戲/">遊戲</a><small>8</small></li>
  
  </ul>
</div>



<div class="widget twitter">
  <h3 class="title">Tweets</h3>
  <ul id="tweets"></ul>
</div>

<script type="text/javascript">
var twitter_stream = ['tommy351', 5, false];
</script>
<script src="/js/twitter.js"></script>

</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2013 SkyArrow
  
</div>
<div class="clearfix"></div></footer>
  <script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>


<script type="text/javascript">
var disqus_shortname = 'zespiatw';

(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
</script>



<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>

</body>
</html>